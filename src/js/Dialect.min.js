/**
*   Dialect, 
*   a simple and flexible Cross-Platform SQL Builder for PHP, Python, Node/XPCOM/JS, ActionScript
* 
*   @version: 0.5.1
*   https://github.com/foo123/Dialect
*
*   Abstract the construction of SQL queries
*   Support multiple DB vendors
*   Intuitive and Flexible API
**/
!function(e,t,n){"use strict";var l;"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?(e.EXPORTED_SYMBOLS=[t])&&(e[t]=n.call(e)):"object"==typeof module&&module.exports?module.exports=n.call(e):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(t)?define(t,["require","exports","module"],function(){return n.call(e)}):t in e||(e[t]=l=n.call(e))&&"function"==typeof define&&define.amd&&define(function(){return l})}(this,"Dialect",function(e,t){"use strict";function n(e,t){return new Function(e,t)}function l(e,t){return new RegExp(e,t||"")}function s(e){return e.replace(I,"\\$&")}function r(e){return"function"==typeof e}function o(e){return"string"==typeof e}function i(e){return e instanceof Array||"[object Array]"===w.call(e)}function u(e){return e instanceof Object||"[object Object]"===w.call(e)}function c(e){if(!e)return!0;var t=w.call(e);return(e instanceof Array||e instanceof String||"[object Array]"===t||"[object String]"===t)&&!e.length?!0:(e instanceof Object||"[object Array]"===t)&&!R(e).length?!0:!1}function a(e){return parseInt(e||0,10)||0}function _(e){return e===+e&&isFinite(e)&&!(e%1)}function f(e){return i(e)?e:[e]}function d(e,t,n){var l,s,r,o="";for(3>arguments.length&&(n="\\"),2>arguments.length&&(t="\\\"'"+j),l=0,s=e.length;s>l;l++)r=e[O](l),o+=-1===t.indexOf(r)?r:0===r[S](0)?"\\0":n+r;return o}function p(e,t,n){n=!0===n;for(var l in t)t[T](l)&&(n||!e[T](l))&&(e[l]=t[l]);return e}function h(e,t){var n=e.length;if(!n)return[];var l,s,r=15&n,o=1&r,i=new Array(n);for(o&&(i[0]=t(e[0])),l=o;r>l;l+=2)s=l,i[l]=t(e[s]),i[l+1]=t(e[s+1]);for(l=r;n>l;l+=16)s=l,i[l]=t(e[s]),i[l+1]=t(e[s+1]),i[l+2]=t(e[s+2]),i[l+3]=t(e[s+3]),i[l+4]=t(e[s+4]),i[l+5]=t(e[s+5]),i[l+6]=t(e[s+6]),i[l+7]=t(e[s+7]),i[l+8]=t(e[s+8]),i[l+9]=t(e[s+9]),i[l+10]=t(e[s+10]),i[l+11]=t(e[s+11]),i[l+12]=t(e[s+12]),i[l+13]=t(e[s+13]),i[l+14]=t(e[s+14]),i[l+15]=t(e[s+15]);return i}function b(e,t){var n=e.length;if(!n)return[];var l,s,r=15&n,o=1&r,i=[];for(o&&t(e[0])&&i.push(e[0]),l=o;r>l;l+=2)s=l,t(e[s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]);for(l=r;n>l;l+=16)s=l,t(e[s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]),t(e[++s])&&i.push(e[s]);return i}var E,g,v,q,m="prototype",T="hasOwnProperty",R=Object.keys,w=Object[m].toString,O="charAt",S="charCodeAt",I=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,A=/^\s+|\s+$/g,L=String[m].trim?function(e){return e.trim()}:function(e){return e.replace(A,"")},j=String.fromCharCode(0);E=function D(e,t,n){var l=this;return l instanceof D?(l.id=null,l._renderer=null,t=t||D.defaultArgs,l.tpl=t instanceof RegExp?D.multisplit_re(e||"",t):D.multisplit(e||"",t),!0===n&&(l._renderer=D.compile(l.tpl)),void l.fixRenderer()):new D(e,t,n)},E.defaultArgs=/\$(-?[0-9]+)/g,E.multisplit=function(e,t,n){var l,s,r,o,i,u,c,a,_,f;n=!!n,u=[[1,e]];for(l in t)if(t.hasOwnProperty(l)){for(a=[],s=n?t[l]:l,r=[0,t[l]],o=0,_=u.length;_>o;o++)if(1===u[o][0]){if(c=u[o][1].split(s),f=c.length,a.push([1,c[0]]),f>1)for(i=0;f-1>i;i++)a.push(r),a.push([1,c[i+1]])}else a.push(u[o]);u=a}return u},E.multisplit_re=function(e,t){t=t.global?t:new RegExp(t.source,t.ignoreCase?"gi":"g");for(var n,l=[],s=0;n=t.exec(e);)l.push([1,e.slice(s,t.lastIndex-n[0].length)]),l.push([0,n[1]?n[1]:n[0]]),s=t.lastIndex;return l.push([1,e.slice(s)]),l},E.arg=function(e,t){var n,l,s,r,o,i="args";if(arguments.length&&null!=e)for(e=e.substr?e.length?e.split("."):[]:[e],r=e.length,o=!(!t||!t.substr),n=0;r>n;n++)l=e[n],s=+l,isNaN(s)?i+='["'+l+'"]':(0>s&&(l=o?t+-s:i+".length-"+-s),i+="["+l+"]");return i},E.compile=function(e,t){var l,s,r,o,i=e.length;if(!0===t){for(o='"use strict"; return (',l=0;i>l;l++)s=e[l][0],r=e[l][1],o+=s?r:E.arg(r);o+=");"}else{for(o='"use strict"; var argslen=args.length; return (',l=0;i>l;l++)s=e[l][0],r=e[l][1],o+=s?"'"+r.replace(SQUOTE,"\\'").replace(NEWLINE,"' + \"\\n\" + '")+"'":" + String("+E.arg(r,"argslen")+") + ";o+=");"}return n("args",o)},E[m]={constructor:E,id:null,tpl:null,_renderer:null,dispose:function(){return this.id=null,this.tpl=null,this._renderer=null,this},fixRenderer:function(){return this.render="function"==typeof this._renderer?this._renderer:this.constructor[m].render,this},render:function(e){e=e||[];var t,n,l,s=this.tpl,r=s.length,o=e.length,i="";for(t=0;r>t;t++)n=s[t],1===n[0]?i+=n[1]:(l=n[1],+l===l&&0>l&&(l=o+l),i+=e[l]);return i}},g=function N(e,t){var n=this;return n instanceof N?(n.id=null,void(n.tpl=N.multisplit(e||"",t||N.defaultDelims))):new N(e,t)},g.defaultDelims=["<",">","[","]","?","*","!","|","{","}"],g.multisplit=function(e,t){var n,l,s,r,o,i,u,c,a,_,f,d,p=t[0],h=t[1],b=t[2],E=t[3],g=t[4],v=t[5],q=t[6],m=t[7],T=t[8],R=t[9],w=null,S=0,I=0,A=e.length;for(_=0,u=[[],null,0,0,0,0],o=[],a="";A>_;)if(i=e[O](_++),p===i)a.length&&u[0].push([0,a]),a="";else if(h===i){if(s=a,a="",-1<(r=s.indexOf(m))?(w=s.slice(r+1),s=s.slice(0,r)):w=null,i=s[O](0),g===i||v===i)I=1,v===i?(n=1,l=-1):(n=0,l=0),s=s.slice(1),q===s[O](0)?(S=1,s=s.slice(1)):S=0;else if(T===i){for(a="",f=1,d=s.length;d>f&&R!==s[O](f);)a+=s[O](f++);s=s.slice(f+1),a=a.split(","),a.length>1?(n=L(a[0]),n=n.length?parseInt(n,10)||0:0,l=L(a[1]),l=l.length?parseInt(l,10)||0:-1,I=1):(n=L(a[0]),n=n.length?parseInt(n,10)||0:0,l=n,I=0),a="",S=0}else I=0,S=0,n=0,l=0;S&&null===w&&(w=""),I&&!u[2]?(u[1]=s,u[2]=I,u[3]=S,u[4]=n,u[5]=l):I||null!==u[1]||(u[1]=s,u[2]=0,u[3]=S,u[4]=n,u[5]=l),u[0].push([1,s,w,I,S,n,l])}else b===i?(a.length&&u[0].push([0,a]),a="",o.push(u),u=[[],null,0,0,0,0]):E===i?(c=u,u=o.pop(),a.length&&c[0].push([0,a]),a="",u[0].push([-1,c[1],c[2],c[3],c[4],c[5],c[0]])):a+=i;return a.length&&u[0].push([0,a]),u[0]},g[m]={constructor:g,id:null,tpl:null,dispose:function(){return this.id=null,this.tpl=null,this},render:function(e){e=e||{};var t,n,l,s,r,o,u,c,a=this.tpl,_=a.length,f=[],d=Math.min,p=null,h=0,b="";for(l=0;_>l||f.length;)if(l>=_)t=f.pop(),a=t[0],l=t[1],_=t[2],p=t[3]||null,h=t[4]||0;else{if(s=a[l],r=s[0],o=s[1],-1===r){if(0===s[3]&&e[T](o)||1===s[3]&&!e[T](o)){if(1===s[3]){f.push([a,l+1,_,p,h]),a=s[6],l=0,_=a.length,p=null,h=0;continue}if(n=i(e[o]),n&&s[4]!==s[5]&&e[o].length>s[4]){if(u=s[4],c=-1===s[5]?e[o].length-1:d(s[5],e[o].length-1),c>=u){for(f.push([a,l+1,_,p,h]),a=s[6],l=0,_=a.length,p=o,h=c;h>u;h--)f.push([a,0,_,p,h]);h=u;continue}}else if(!n&&s[4]===s[5]){f.push([a,l+1,_,p,h]),a=s[6],l=0,_=a.length,p=o,h=0;continue}}}else b+=1===r?e[T](o)||null===s[2]?i(e[o])?o===p?e[o][s[5]===s[6]?s[5]:h]:e[o][s[5]]:e[o]:s[2]:o;l++}return b}},v=function(e,t,n,l,s,r,o,i,u,c,a,_){var f=this;f.col=e,f.col_q=t,f.tbl=n,f.tbl_q=l,f.dtb=s,f.dtb_q=r,f.alias=o,f.alias_q=i,f.tbl_col=u,f.tbl_col_q=c,f.tbl_col_alias=a,f.tbl_col_alias_q=_},v.parse=function(e,t){var n,l,s,r,o,i,u,c,a,_,f,d;return e=L(e).split(" AS "),n=e[0].split("."),3<=n.length?(o=L(n[0]),s=L(n[1]),n=L(n[2])):2===n.length?(o=null,s=L(n[0]),n=L(n[1])):(o=null,s=null,n=L(n[0])),l=t.quote_name(n),null!==o?(i=t.quote_name(o),r=t.quote_name(s),a=o+"."+s+"."+n,_=i+"."+r+"."+l):null!==s?(i=null,r=t.quote_name(s),a=s+"."+n,_=r+"."+l):(i=null,r=null,a=n,_=l),e.length<2?(u=a,c=_,f=a,d=_):(u=L(e[1]),c=t.quote_name(u),f=a+" AS "+u,d=_+" AS "+c),new v(n,l,s,r,o,i,u,c,a,_,f,d)},v[m]={constructor:v,col:null,col_q:null,tbl:null,tbl_q:null,dtb:null,dtb_q:null,alias:null,alias_q:null,tbl_col:null,tbl_col_q:null,tbl_col_alias:null,tbl_col_alias_q:null,dispose:function(){var e=this;return e.col=null,e.col_q=null,e.tbl=null,e.tbl_q=null,e.dtb=null,e.dtb_q=null,e.alias=null,e.alias_q=null,e.tbl_col=null,e.tbl_col_q=null,e.tbl_col_alias=null,e.tbl_col_alias_q=null,e}};var y={mysql:{quotes:[["'","'","\\'","\\'"],["`","`"],["",""]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE <?where_conditions>][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING <?having_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <offset|0>,<?count>]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][\nWHERE <?where_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <offset|0>,<?count>]","delete":"DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE <?where_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <offset|0>,<?count>]"}},postgres:{quotes:[["E'","'","''","''"],['"','"'],["",""]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE <?where_conditions>][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING <?having_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][\nWHERE <?where_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]","delete":"DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE <?where_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]"}},sqlserver:{quotes:[["'","'","''","''"],["[","]"],[""," ESCAPE '\\'"]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE <?where_conditions>][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING <?having_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>][\nOFFSET <offset|0> ROWS FETCH NEXT <?count> ROWS ONLY]][<?!order_conditions>[\nORDER BY 1\nOFFSET <offset|0> ROWS FETCH NEXT <?count> ROWS ONLY]]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][\nWHERE <?where_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]]","delete":"DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE <?where_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]]"}},sqlite:{quotes:[["'","'","''","''"],['"','"'],[""," ESCAPE '\\'"]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE <?where_conditions>][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING <?having_conditions>][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][\nWHERE <?where_conditions>]","delete":"[<?!order_conditions>[<?!count>DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE <?where_conditions>]]][DELETE \nFROM <from_tables>[,<*from_tables>] WHERE rowid IN (\nSELECT rowid FROM <from_tables>[,<*from_tables>][\nWHERE <?where_conditions>]\nORDER BY <?order_conditions>[,<*order_conditions>][\nLIMIT <?count> OFFSET <offset|0>]\n)][<?!order_conditions>[DELETE \nFROM <from_tables>[,<*from_tables>] WHERE rowid IN (\nSELECT rowid FROM <from_tables>[,<*from_tables>][\nWHERE <?where_conditions>]\nLIMIT <?count> OFFSET <offset|0>\n)]]"}}};return q=function F(e){var t=this;if(!(t instanceof F))return new F(e);if(arguments.length||(e="mysql"),!e||!F.dialects[e]||!F.dialects[e].clauses)throw new TypeError('Dialect: SQL dialect does not exist for "'+e+'"');t.clau=null,t.clus=null,t.tbls=null,t.cols=null,t.vews={},t.tpls={},t.db=null,t.escdb=null,t.p="",t.type=e,t.clauses=F.dialects[t.type].clauses,t.q=F.dialects[t.type].quotes[0],t.qn=F.dialects[t.type].quotes[1],t.e=F.dialects[t.type].quotes[2]||["",""]},q.VERSION="0.5.1",q.TPL_RE=/\$\(([^\)]+)\)/g,q.dialects=y,q.GrammTpl=g,q.Tpl=E,q.Ref=v,q[m]={constructor:q,clau:null,clus:null,tbls:null,cols:null,vews:null,tpls:null,db:null,escdb:null,p:null,type:null,clauses:null,q:null,qn:null,e:null,dispose:function(){var e=this;return e.clau=null,e.clus=null,e.tbls=null,e.cols=null,e.vews=null,e.tpls=null,e.db=null,e.escdb=null,e.p=null,e.type=null,e.clauses=null,e.q=null,e.qn=null,e.e=null,e},toString:function(){return this.sql()||""},driver:function(e){var t=this;return arguments.length?(t.db=e?e:null,t):t.db},escape:function(e){var t=this;return arguments.length?(t.escdb=e&&r(e)?e:null,t):t.escdb},prefix:function(e){var t=this;return arguments.length?(t.p=e&&e.length?e:"",t):t.p},reset:function(e){var t=this;if(!e||!t.clauses[T](e))throw new TypeError('Dialect: SQL clause "'+e+'" does not exist for dialect "'+t.type+'"');return t.clus={},t.tbls={},t.cols={},t.clau=e,t.clauses[t.clau]instanceof g||(t.clauses[t.clau]=new g(t.clauses[t.clau])),t},clear:function(){var e=this;return e.clau=null,e.clus=null,e.tbls=null,e.cols=null,e},sql:function(){var e=this,t=null;return e.clau&&e.clauses[T](e.clau)&&(t=e.clauses[e.clau].render(e.clus)||""),e.clear(),t},prepare:function(e,t,n,r){var o,u,c,a,_,d,p,h,b,E,g=this;if(e&&t){for(n=n?s(n):"%",r=r?s(r):"%",o=l(n+"([rlfds]:)?([0-9a-zA-Z_]+)"+r),E="";e.length&&(u=e.match(o));){if(c=u.index,a=u[0].length,h=u[2],t[T](h)){switch(b=u[1]?u[1].slice(0,-1):"s"){case"r":h=i(t[h])?t[h].join(","):t[h];break;case"l":h=g.like(t[h]);break;case"f":if(i(t[h]))for(p=f(t[h]),h=v.parse(p[0],g).tbl_col_alias_q,_=1,d=p.length;d>_;_++)h+=","+v.parse(p[_],g).tbl_col_alias_q;else h=v.parse(t[h],g).tbl_col_alias_q;break;case"d":h=i(t[h])?g.intval(f(t[h])).join(","):g.intval(t[h]);break;case"s":default:h=i(t[h])?g.quote(f(t[h])).join(","):g.quote(t[h])}E+=e.slice(0,c)+h}else E+=e.slice(0,c)+g.quote("");e=e.slice(c+a)}return e.length&&(E+=e),E}return e},make_view:function(e){var t=this;return e&&t.clau&&(t.vews[e]={clau:t.clau,clus:t.clus,tbls:t.tbls,cols:t.cols},t.clear()),t},clear_view:function(e){var t=this;return e&&t.vews[T](e)&&delete t.vews[e],t},prepare_tpl:function(e){var t,n,r,o,i,u,a,_,f,d,p,h,b,g=this;if(!c(e)){for(_=arguments,f=_.length,1===f?(d=null,p=null,h=null,b=!0):2===f?(d=_[1],p=null,h=null,b=!1):3===f?(d=null,p=_[1],h=_[2],b=!0):(d=_[1],p=_[2],h=_[3],b=!1),p=p?s(p):"%",h=h?s(h):"%",t=l(p+"(([rlfds]:)?[0-9a-zA-Z_]+)"+h),n=b?new E(g.sql(),t):new E(d,t),r={},o=0,i=n.tpl.length;i>o;o++)u=n.tpl[o],0===u[0]&&(a=u[1].split(":"),a.length>1?(r[a[1]]=a[0],n.tpl[o][1]=a[1]):(r[a[0]]="s",n.tpl[o][1]=a[0]));g.tpls[e]={sql:n,types:r}}return g},prepared:function(e,t){var n,l,s,r,o,u,a,_,d,p=this;if(!c(e)&&p.tpls[T](e)){n=p.tpls[e].sql,l=p.tpls[e].types,r={};for(o in t)if(t[T](o))switch(u=t[o],s=l[T](o)?l[o]:"s"){case"r":r[o]=i(u)?u.join(","):u;break;case"l":r[o]=p.like(u);break;case"f":if(i(u))for(a=f(u),r[o]=v.parse(a[0],p).tbl_col_alias_q,_=1,d=a.length;d>_;_++)r[o]+=","+v.parse(a[_],p).tbl_col_alias_q;else r[o]=DialectRef.parse(u,p).tbl_col_alias_q;break;case"d":r[o]=i(u)?p.intval(f(u)).join(","):p.intval(u);break;case"s":default:r[o]=i(u)?p.quote(f(u)).join(","):p.quote(u)}return n.render(r)}return""},clear_tpl:function(e){var t=this;return!c(e)&&t.tpls[T](e)&&(t.tpls[e].sql.dispose(),delete t.tpls[e]),t},create:function(e,t,n,l,s){var r=this;return r.reset(s||"create"),!1!==l&&(e=r.refs(e,r.tbls)[0].tbl_col_q),r.clus.create_table=e,r.clus.create_defs&&(t=r.clus.create_defs+","+t),r.clus.create_defs=t,n&&(r.clus.create_opts&&(n=r.clus.create_opts+","+n),r.clus.create_opts=n),r},alter:function(e,t,n,l,s){var r=this;return r.reset(s||"alter"),!1!==l&&(e=r.refs(e,r.tbls)[0].tbl_col_q),r.clus.alter_table=e,r.clus.alter_defs&&(t=r.clus.alter_defs+","+t),r.clus.alter_defs=t,n&&(r.clus.alter_opts&&(n=r.clus.alter_opts+","+n),r.clus.alter_opts=n),r},drop:function(e,t,n){var l,s,r,o=this;if(o.reset(n||"drop"),e&&e.length&&"*"!==e)if(!1!==t)for(r=o.refs(e,o.tbls),e=r[0].tbl_col_q,l=1,s=r.length;s>l;l++)e+=","+r[l].tbl_col_q;else e=f(e).join(",");else e="*";return o.clus.drop_tables&&(e=o.clus.drop_tables+","+e),o.clus.drop_tables=e,o},select:function(e,t,n){var l,s,r,o=this;if(o.reset(n||"select"),e&&e.length&&"*"!==e)if(!1!==t)for(e=o.refs(e,o.cols),r=e[0].tbl_col_alias_q,l=1,s=e.length;s>l;l++)r+=","+e[l].tbl_col_alias_q;else r=f(e).join(",");else r="*";return o.clus.select_columns&&(r=o.clus.select_columns+","+r),o.clus.select_columns=r,o},insert:function(e,t,n,l){var s,r,o,u,c,a=this;if(a.reset(l||"insert"),o=i(e)?e[0]:e,a.vews[T](o)&&a.clau===a.vews[o].clau)o=a.vews[o],a.clus=p(a.clus,o.clus,!0),a.tbls=p({},o.tbls,!0),a.cols=p({},o.cols,!0);else{if(!1!==n){for(e=a.refs(e,a.tbls),t=a.refs(t,a.cols),u=e[0].tbl_col_alias_q,c=t[0].tbl_col_q,s=1,r=e.length;r>s;s++)u+=","+e[s].tbl_col_alias_q;for(s=1,r=t.length;r>s;s++)c+=","+t[s].tbl_col_q}else u=f(e).join(","),c=f(t).join(",");a.clus.insert_tables&&(u=a.clus.insert_tables+","+u),a.clus.insert_columns&&(c=a.clus.insert_columns+","+c),a.clus.insert_tables=u,a.clus.insert_columns=c}return a},values:function(e){var n,l,s,r,o,a,d,p,h=this;if(c(e))return h;for(t!==e[0]&&i(e[0])||(e=[e]),n=e.length,l=[],r=0;n>r;r++)if(p=f(e[r]),p.length){for(s=[],a=0,d=p.length;d>a;a++)o=p[a],u(o)?o[T]("integer")?s.push(h.intval(o.integer)):o[T]("raw")?s.push(o.raw):o[T]("string")&&s.push(h.quote(o.string)):s.push(_(o)?o:h.quote(o));l.push("("+s.join(",")+")")}return l=l.join(","),h.clus.values_values&&(l=h.clus.values_values+","+l),h.clus.values_values=l,h},update:function(e,t,n){var l,s,r,o,u=this;if(u.reset(n||"update"),r=i(e)?e[0]:e,u.vews[T](r)&&u.clau===u.vews[r].clau)r=u.vews[r],u.clus=p(u.clus,r.clus,!0),u.tbls=p({},r.tbls,!0),u.cols=p({},r.cols,!0);else{if(!1!==t)for(e=u.refs(e,u.tbls),o=e[0].tbl_col_alias_q,l=1,s=e.length;s>l;l++)o+=","+e[l].tbl_col_alias_q;else o=f(e).join(",");u.clus.update_tables&&(o=u.clus.update_tables+","+o),u.clus.update_tables=o}return u},set:function(e){var t,n,l,s,r,o=this;if(c(e))return o;t=[],r=o.cols;for(n in e)e[T](n)&&(l=o.refs(n,r)[0].tbl_col_q,s=e[n],u(s)?s[T]("integer")?t.push(l+" = "+o.intval(s.integer)):s[T]("raw")?t.push(l+" = "+s.raw):s[T]("string")?t.push(l+" = "+o.quote(s.string)):s[T]("increment")?t.push(l+" = "+l+" + "+o.intval(s.increment)):s[T]("decrement")&&t.push(l+" = "+l+" - "+o.intval(s.increment)):t.push(l+" = "+(_(s)?s:o.quote(s))));return t=t.join(","),o.clus.set_values&&(t=o.clus.set_values+","+t),o.clus.set_values=t,o},del:function(e){var t=this;return t.reset(e||"delete"),t},from:function(e,t){var n,l,s,r,o=this;if(c(e))return o;if(s=i(e)?e[0]:e,o.vews[T](s)&&o.clau===o.vews[s].clau)s=o.vews[s],o.clus=p(o.clus,s.clus,!0),o.tbls=p({},s.tbls,!0),o.cols=p({},s.cols,!0);else{if(!1!==t)for(e=o.refs(e,o.tbls),r=e[0].tbl_col_alias_q,n=1,l=e.length;l>n;n++)r+=","+e[n].tbl_col_alias_q;else r=f(e).join(",");o.clus.from_tables&&(r=o.clus.from_tables+","+r),o.clus.from_tables=r}return o},join:function(e,t,n){var l,s,r,i=this;if(e=i.refs(e,i.tbls)[0].tbl_col_alias_q,c(t))l=e;else{if(o(t))t=i.refs(t.split("="),i.cols),t="("+t[0].tbl_col_q+"="+t[1].tbl_col_q+")";else{for(s in t)t[T](s)&&(r=t[s],u(r)||(t[s]={eq:r,type:"identifier"}));t=i.conditions(t,!1)}l=e+" ON "+t}return l=(c(n)?"JOIN ":n.toUpperCase()+" JOIN ")+l,i.clus.join_clauses&&(l=i.clus.join_clauses+"\n"+l),i.clus.join_clauses=l,i},where:function(e,t){var n=this;return c(e)?n:(t=t?t.toUpperCase():"AND","OR"!==t&&(t="AND"),e=n.conditions(e,!1),n.clus.where_conditions&&(e=n.clus.where_conditions+" "+t+" "+e),n.clus.where_conditions=e,n)},group:function(e,t){var n,l=this;return t=t?t.toUpperCase():"ASC","DESC"!==t&&(t="ASC"),n=l.refs(e,l.cols)[0].alias_q+" "+t,l.clus.group_conditions&&(n=l.clus.group_conditions+","+n),l.clus.group_conditions=n,l},having:function(e,t){var n=this;return c(e)?n:(t=t?t.toUpperCase():"AND","OR"!==t&&(t="AND"),e=n.conditions(e,!0),n.clus.having_conditions&&(e=n.clus.having_conditions+" "+t+" "+e),n.clus.having_conditions=e,n)},order:function(e,t){var n,l=this;return t=t?t.toUpperCase():"ASC","DESC"!==t&&(t="ASC"),n=l.refs(e,l.cols)[0].alias_q+" "+t,l.clus.order_conditions&&(n=l.clus.order_conditions+","+n),l.clus.order_conditions=n,l},limit:function(e,t){var n=this;return n.clus.count=a(e),n.clus.offset=a(t),n},page:function(e,t){var n=this;return e=a(e),t=a(t),n.limit(t,e*t)},refs:function(e,t){var n,l,s,r,o,i,u,c=this;for(i=f(e),e=[],n=0,l=i.length;l>n;n++)for(o=i[n].split(","),s=0,r=o.length;r>s;s++)u=v.parse(o[s],c),t[T](u.tbl_col)?u=t[u.tbl_col]:(t[u.tbl_col]=u,u.tbl_col!==u.alias&&(t[u.alias]=u)),e.push(u);return e},join_conditions:function(e,t){var n,l,s,r,o,i,u,c,a,_,f,d,p=this,h=0;for(n in t)t[T](n)&&(l=v.parse(n,p),s=l.col,e[T](s)&&(r=t[n],i=e[s].table,u=e[s].id,c=e[s].join,a=e[s].join_id,h++,_=c+h,o={},e[s][T]("key")&&s!==e[s].key?(f=e[s].key,o[_+"."+f]=s):f=s,e[s][T]("value")?(d=e[s].value,o[_+"."+d]=r):(d=f,o[_+"."+d]=r),p.join(c+" AS "+_,i+"."+u+"="+_+"."+a,"inner").where(o),delete t[n]));return p},conditions:function(e,t){var n,l,s,r,i,a,d,p,h,b,E=this;if(c(e))return"";if(o(e))return e;n="",l=[],b=E.cols,a=!0===t?"alias_q":"tbl_col_q";for(s in e)e[T](s)&&(r=E.refs(s,b)[0][a],i=e[s],u(i)?(p=i[T]("type")?i.type:"string",i[T]("multi_like")?l.push(E.multi_like(r,i.multi_like)):i[T]("like")?l.push(r+" LIKE "+("raw"===p?i.like:E.like(i.like))):i[T]("not_like")?l.push(r+" NOT LIKE "+("raw"===p?i.not_like:E.like(i.not_like))):i[T]("in")?(h=f(i["in"]),"raw"===p||(h="integer"===p||_(h[0])?E.intval(h):E.quote(h)),l.push(r+" IN ("+h.join(",")+")")):i[T]("not_in")?(h=f(i.not_in),"raw"===p||(h="integer"===p||_(h[0])?E.intval(h):E.quote(h)),l.push(r+" NOT IN ("+h.join(",")+")")):i[T]("between")?(h=f(i.between),"raw"===p||(h="integer"===p||_(h[0])&&_(h[1])?E.intval(h):E.quote(h)),l.push(r+" BETWEEN "+h[0]+" AND "+h[1])):i[T]("not_between")?(h=f(i.not_between),"raw"===p||(h="integer"===p||_(h[0])&&_(h[1])?E.intval(h):E.quote(h)),l.push(r+" < "+h[0]+" OR "+r+" > "+h[1])):i[T]("gt")||i[T]("gte")?(d=i[T]("gt")?"gt":"gte",h=i[d],"raw"===p||(h="integer"===p||_(h)?E.intval(h):"identifier"===p||"field"===p?E.refs(h,b)[0][a]:E.quote(h)),l.push(r+("gt"===d?" > ":" >= ")+h)):i[T]("lt")||i[T]("lte")?(d=i[T]("lt")?"lt":"lte",h=i[d],"raw"===p||(h="integer"===p||_(h)?E.intval(h):"identifier"===p||"field"===p?E.refs(h,b)[0][a]:E.quote(h)),l.push(r+("lt"===d?" < ":" <= ")+h)):i[T]("not_equal")||i[T]("not_eq")?(d=i[T]("not_eq")?"not_eq":"not_equal",h=i[d],"raw"===p||(h="integer"===p||_(h)?E.intval(h):"identifier"===p||"field"===p?E.refs(h,b)[0][a]:E.quote(h)),l.push(r+" <> "+h)):(i[T]("equal")||i[T]("eq"))&&(d=i[T]("eq")?"eq":"equal",h=i[d],"raw"===p||(h="integer"===p||_(h)?E.intval(h):"identifier"===p||"field"===p?E.refs(h,b)[0][a]:E.quote(h)),l.push(r+" = "+h))):l.push(r+" = "+(_(i)?i:E.quote(i))));return l.length&&(n="("+l.join(") AND (")+")"),n},tbl:function(e){var t=this,n=t.p;return i(e)?h(e,function(e){return n+e}):n+e},intval:function(e){return i(e)?h(e,a):a(e)},quote_name:function(e){var t=this,n=t.qn;return i(e)?h(e,function(e){return"*"===e?e:n[0]+e+n[1]}):"*"===e?e:n[0]+e+n[1]},quote:function(e){var t=this,n=t.q;return i(e)?h(e,function(e){return n[0]+t.esc(e)+n[1]}):n[0]+t.esc(e)+n[1]},like:function(e){var t=this,n=t.q,l=t.escdb?["",""]:t.e;return i(e)?h(e,function(e){return l[0]+n[0]+"%"+t.esc_like(t.esc(e))+"%"+n[1]+l[1]}):l[0]+n[0]+"%"+t.esc_like(t.esc(e))+"%"+n[1]+l[1]},multi_like:function(e,t,n){var l,s,r,o,i,u,c,a=this;for(n=!1!==n,l=e+" LIKE ",s=t.split(","),n&&(s=b(h(s,L),Boolean)),o=0,i=s.length;i>o;o++){for(r=s[o].split("+"),n&&(r=b(h(r,L),Boolean)),u=0,c=r.length;c>u;u++)r[u]=l+a.like(r[u]);s[o]="("+r.join(" AND ")+")"}return s.join(" OR ")},esc:function(e){var t,n,l,s,r,o,u=this,c=u.q;if(u.escdb)return i(e)?h(e,u.escdb):u.escdb(e);if(i(e))return h(e,function(e){return u.esc(e)});for(t="\\"+j,n="\\",e=String(e),r="",l=0,s=e.length;s>l;l++)o=e.charAt(l),r+=c[0]===o?c[2]:c[1]===o?c[3]:d(o,t,n);return r},esc_like:function(e){var t="_%",n="\\";return i(e)?h(e,function(e){return d(e,t,n)}):d(e,t,n)}},q});