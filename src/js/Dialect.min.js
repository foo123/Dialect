/**
*   Dialect, 
*   a simple and flexible Cross-Platform SQL Builder for PHP, Python, Node/XPCOM/JS, ActionScript
* 
*   @version: 0.5.4
*   https://github.com/foo123/Dialect
*
*   Abstract the construction of SQL queries
*   Support multiple DB vendors
*   Intuitive and Flexible API
**/
!function(e,n,t){"use strict";var l;"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?(e.EXPORTED_SYMBOLS=[n])&&(e[n]=t.call(e)):"object"==typeof module&&module.exports?module.exports=t.call(e):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(n)?define(n,["require","exports","module"],function(){return t.call(e)}):n in e||(e[n]=l=t.call(e))&&"function"==typeof define&&define.amd&&define(function(){return l})}(this,"Dialect",function(e,n){"use strict";function t(e,n){return new Function(e,n)}function l(e,n){return new RegExp(e,n||"")}function s(e){return e.replace(S,"\\$&")}function r(e){return"function"==typeof e}function i(e){return"string"==typeof e}function o(e){return e instanceof Array||"[object Array]"===T.call(e)}function u(e){return e instanceof Object||"[object Object]"===T.call(e)}function c(e){if(!e)return!0;var n=T.call(e);return(e instanceof Array||e instanceof String||"[object Array]"===n||"[object String]"===n)&&!e.length?!0:(e instanceof Object||"[object Array]"===n)&&!R(e).length?!0:!1}function a(e){return parseInt(e||0,10)||0}function _(e){return e===+e&&isFinite(e)&&!(e%1)}function d(e){return o(e)?e:[e]}function f(e,n,t){var l,s,r,i="";for(3>arguments.length&&(t="\\"),2>arguments.length&&(n="\\\"'"+D),l=0,s=e.length;s>l;l++)r=e[A](l),i+=-1===n.indexOf(r)?r:0===r[O](0)?"\\0":t+r;return i}function h(e,n,t){t=!0===t;for(var l in n)n[m](l)&&(t||!e[m](l))&&(e[l]=n[l]);return e}function p(e,n){var t=e.length;if(!t)return[];var l,s,r=15&t,i=1&r,o=new Array(t);for(i&&(o[0]=n(e[0])),l=i;r>l;l+=2)s=l,o[l]=n(e[s]),o[l+1]=n(e[s+1]);for(l=r;t>l;l+=16)s=l,o[l]=n(e[s]),o[l+1]=n(e[s+1]),o[l+2]=n(e[s+2]),o[l+3]=n(e[s+3]),o[l+4]=n(e[s+4]),o[l+5]=n(e[s+5]),o[l+6]=n(e[s+6]),o[l+7]=n(e[s+7]),o[l+8]=n(e[s+8]),o[l+9]=n(e[s+9]),o[l+10]=n(e[s+10]),o[l+11]=n(e[s+11]),o[l+12]=n(e[s+12]),o[l+13]=n(e[s+13]),o[l+14]=n(e[s+14]),o[l+15]=n(e[s+15]);return o}function b(e,n){var t=e.length;if(!t)return[];var l,s,r=15&t,i=1&r,o=[];for(i&&n(e[0])&&o.push(e[0]),l=i;r>l;l+=2)s=l,n(e[s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]);for(l=r;t>l;l+=16)s=l,n(e[s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]),n(e[++s])&&o.push(e[s]);return o}var E,g,q,v,w="prototype",m="hasOwnProperty",R=Object.keys,T=Object[w].toString,A="charAt",O="charCodeAt",S=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,I=/^\s+|\s+$/g,N=String[w].trim?function(e){return e.trim()}:function(e){return e.replace(I,"")},D=String.fromCharCode(0);E=function j(e,n,t){var l=this;return l instanceof j?(l.id=null,l._renderer=null,n=n||j.defaultArgs,l.tpl=n instanceof RegExp?j.multisplit_re(e||"",n):j.multisplit(e||"",n),!0===t&&(l._renderer=j.compile(l.tpl)),void l.fixRenderer()):new j(e,n,t)},E.defaultArgs=/\$(-?[0-9]+)/g,E.multisplit=function(e,n,t){var l,s,r,i,o,u,c,a,_,d;t=!!t,u=[[1,e]];for(l in n)if(n.hasOwnProperty(l)){for(a=[],s=t?n[l]:l,r=[0,n[l]],i=0,_=u.length;_>i;i++)if(1===u[i][0]){if(c=u[i][1].split(s),d=c.length,a.push([1,c[0]]),d>1)for(o=0;d-1>o;o++)a.push(r),a.push([1,c[o+1]])}else a.push(u[i]);u=a}return u},E.multisplit_re=function(e,n){n=n.global?n:new RegExp(n.source,n.ignoreCase?"gi":"g");for(var t,l=[],s=0;t=n.exec(e);)l.push([1,e.slice(s,n.lastIndex-t[0].length)]),l.push([0,t[1]?t[1]:t[0]]),s=n.lastIndex;return l.push([1,e.slice(s)]),l},E.arg=function(e,n){var t,l,s,r,i,o="args";if(arguments.length&&null!=e)for(e=e.substr?e.length?e.split("."):[]:[e],r=e.length,i=!(!n||!n.substr),t=0;r>t;t++)l=e[t],s=+l,isNaN(s)?o+='["'+l+'"]':(0>s&&(l=i?n+-s:o+".length-"+-s),o+="["+l+"]");return o},E.compile=function(e,n){var l,s,r,i,o=e.length;if(!0===n){for(i='"use strict"; return (',l=0;o>l;l++)s=e[l][0],r=e[l][1],i+=s?r:E.arg(r);i+=");"}else{for(i='"use strict"; var argslen=args.length; return (',l=0;o>l;l++)s=e[l][0],r=e[l][1],i+=s?"'"+r.replace(SQUOTE,"\\'").replace(NEWLINE,"' + \"\\n\" + '")+"'":" + String("+E.arg(r,"argslen")+") + ";i+=");"}return t("args",i)},E[w]={constructor:E,id:null,tpl:null,_renderer:null,dispose:function(){return this.id=null,this.tpl=null,this._renderer=null,this},fixRenderer:function(){return this.render="function"==typeof this._renderer?this._renderer:this.constructor[w].render,this},render:function(e){e=e||[];var n,t,l,s=this.tpl,r=s.length,i=e.length,o="";for(n=0;r>n;n++)t=s[n],1===t[0]?o+=t[1]:(l=t[1],+l===l&&0>l&&(l=i+l),o+=e[l]);return o}},g=function y(e,n){var t=this;return t instanceof y?(t.id=null,void(t.tpl=y.multisplit(e||"",n||y.defaultDelims))):new y(e,n)},g.defaultDelims=["<",">","[","]"],g.multisplit=function(e,n){var t,l,s,r,i,o,u,c,a,_,d,f,h=n[0],p=n[1],b=n[2],E=n[3],g=h.length,q=p.length,v=b.length,w=E.length,m="?",R="*",T="!",O="|",S="{",I="}",D=null,L=0,j=0,y=e.length;for(_=0,u=[[],null,0,0,0,0],i=[],a="";y>_;)if(h===e.substr(_,g))_+=g,a.length&&u[0].push([0,a]),a="";else if(p===e.substr(_,q)){if(_+=q,s=a,a="",-1<(r=s.indexOf(O))?(D=s.slice(r+1),s=s.slice(0,r)):D=null,o=s[A](0),m===o||R===o)j=1,R===o?(t=1,l=-1):(t=0,l=0),s=s.slice(1),T===s[A](0)?(L=1,s=s.slice(1)):L=0;else if(S===o){for(a="",d=1,f=s.length;f>d&&I!==s[A](d);)a+=s[A](d++);s=s.slice(d+1),a=a.split(","),a.length>1?(t=N(a[0]),t=t.length?parseInt(t,10)||0:0,l=N(a[1]),l=l.length?parseInt(l,10)||0:-1,j=1):(t=N(a[0]),t=t.length?parseInt(t,10)||0:0,l=t,j=0),a="",L=0}else j=0,L=0,t=0,l=0;L&&null===D&&(D=""),j&&!u[2]?(u[1]=s,u[2]=j,u[3]=L,u[4]=t,u[5]=l):j||null!==u[1]||(u[1]=s,u[2]=0,u[3]=L,u[4]=t,u[5]=l),u[0].push([1,s,D,j,L,t,l])}else b===e.substr(_,v)?(_+=v,a.length&&u[0].push([0,a]),a="",i.push(u),u=[[],null,0,0,0,0]):E===e.substr(_,w)?(_+=w,c=u,u=i.pop(),a.length&&c[0].push([0,a]),a="",u[0].push([-1,c[1],c[2],c[3],c[4],c[5],c[0]])):a+=e[A](_++);return a.length&&u[0].push([0,a]),u[0]},g[w]={constructor:g,id:null,tpl:null,dispose:function(){return this.id=null,this.tpl=null,this},render:function(e){e=e||{};var n,t,l,s,r,i,u,c,a=this.tpl,_=a.length,d=[],f=Math.min,h=null,p=0,b="";for(l=0;_>l||d.length;)if(l>=_)n=d.pop(),a=n[0],l=n[1],_=n[2],h=n[3]||null,p=n[4]||0;else{if(s=a[l],r=s[0],i=s[1],-1===r){if(0===s[3]&&e[m](i)||1===s[3]&&!e[m](i)){if(1===s[3]){d.push([a,l+1,_,h,p]),a=s[6],l=0,_=a.length,h=null,p=0;continue}if(t=o(e[i]),t&&s[4]!==s[5]&&e[i].length>s[4]){if(u=s[4],c=-1===s[5]?e[i].length-1:f(s[5],e[i].length-1),c>=u){for(d.push([a,l+1,_,h,p]),a=s[6],l=0,_=a.length,h=i,p=c;p>u;p--)d.push([a,0,_,h,p]);p=u;continue}}else if(!t&&s[4]===s[5]){d.push([a,l+1,_,h,p]),a=s[6],l=0,_=a.length,h=i,p=0;continue}}}else b+=1===r?e[m](i)||null===s[2]?o(e[i])?i===h?e[i][s[5]===s[6]?s[5]:p]:e[i][s[5]]:e[i]:s[2]:i;l++}return b}},q=function(e,n,t,l,s,r,i,o,u,c){var a=this;a.col=e,a.col_q=n,a.tbl=t,a.tbl_q=l,a.dtb=s,a.dtb_q=r,a.alias=i,a.alias_q=o,a.tbl_col=u,a.tbl_col_q=c,a.tbl_col_q!==a.alias_q?(a.tbl_col_alias=a.tbl_col+" AS "+a.alias,a.tbl_col_alias_q=a.tbl_col_q+" AS "+a.alias_q):(a.tbl_col_alias=a.tbl_col,a.tbl_col_alias_q=a.tbl_col_q)},q.parse=function(e,n,t){var l,s,r,i,o,u,c,a,_,d;return t=!1!==t,e=N(e).split(" AS "),l=e[0].split("."),3<=l.length?(o=N(l[0]),r=N(l[1]),l=N(l[2])):2===l.length?(o=null,r=N(l[0]),l=N(l[1])):(o=null,r=null,l=N(l[0])),s=t?n.quote_name(l):l,null!==o?(u=t?n.quote_name(o):o,i=t?n.quote_name(r):r,_=o+"."+r+"."+l,d=u+"."+i+"."+s):null!==r?(u=null,i=t?n.quote_name(r):r,_=r+"."+l,d=i+"."+s):(u=null,i=null,_=l,d=s),e.length<2?(c=_,a=d):(c=N(e[1]),a=t?n.quote_name(c):c),new q(l,s,r,i,o,u,c,a,_,d)},q[w]={constructor:q,col:null,col_q:null,tbl:null,tbl_q:null,dtb:null,dtb_q:null,alias:null,alias_q:null,tbl_col:null,tbl_col_q:null,tbl_col_alias:null,tbl_col_alias_q:null,cloned:function(e,n){var t=this;return arguments.length?n=n||e:(e=t.alias,n=t.alias_q),new q(t.col,t.col_q,t.tbl,t.tbl_q,t.dtb,t.dtb_q,e,n,t.tbl_col,t.tbl_col_q)},dispose:function(){var e=this;return e.col=null,e.col_q=null,e.tbl=null,e.tbl_q=null,e.dtb=null,e.dtb_q=null,e.alias=null,e.alias_q=null,e.tbl_col=null,e.tbl_col_q=null,e.tbl_col_alias=null,e.tbl_col_alias_q=null,e}};var L={mysql:{quotes:[["'","'","\\'","\\'"],["`","`"],["",""]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING (<?having_conditions_required>) [AND (<?having_conditions>)]][<?!having_conditions_required>[\nHAVING <?having_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <offset|0>,<?count>]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <offset|0>,<?count>]","delete":"DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <offset|0>,<?count>]"}},postgres:{quotes:[["E'","'","''","''"],['"','"'],["",""]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING (<?having_conditions_required>) [AND (<?having_conditions>)]][<?!having_conditions_required>[\nHAVING <?having_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][[\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]","delete":"DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]"}},sqlserver:{quotes:[["'","'","''","''"],["[","]"],[""," ESCAPE '\\'"]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING (<?having_conditions_required>) [AND (<?having_conditions>)]][<?!having_conditions_required>[\nHAVING <?having_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>][\nOFFSET <offset|0> ROWS FETCH NEXT <?count> ROWS ONLY]][<?!order_conditions>[\nORDER BY 1\nOFFSET <offset|0> ROWS FETCH NEXT <?count> ROWS ONLY]]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]]","delete":"DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]]"}},sqlite:{quotes:[["'","'","''","''"],['"','"'],[""," ESCAPE '\\'"]],clauses:{create:"CREATE TABLE IF NOT EXISTS <create_table>\n(<create_defs>)[<?create_opts>]",alter:"ALTER TABLE <alter_table>\n<alter_defs>[<?alter_opts>]",drop:"DROP TABLE IF EXISTS <drop_tables>[,<*drop_tables>]",select:"SELECT <select_columns>[,<*select_columns>]\nFROM <from_tables>[,<*from_tables>][\n<?join_clauses>[\n<*join_clauses>]][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]][\nGROUP BY <?group_conditions>[,<*group_conditions>]][\nHAVING (<?having_conditions_required>) [AND (<?having_conditions>)]][<?!having_conditions_required>[\nHAVING <?having_conditions>]][\nORDER BY <?order_conditions>[,<*order_conditions>]][\nLIMIT <?count> OFFSET <offset|0>]",insert:"INSERT INTO <insert_tables> (<insert_columns>[,<*insert_columns>])\nVALUES <values_values>[,<*values_values>]",update:"UPDATE <update_tables>\nSET <set_values>[,<*set_values>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]]","delete":"[<?!order_conditions>[<?!count>DELETE \nFROM <from_tables>[,<*from_tables>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]]]][DELETE \nFROM <from_tables>[,<*from_tables>] WHERE rowid IN (\nSELECT rowid FROM <from_tables>[,<*from_tables>][\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]]\nORDER BY <?order_conditions>[,<*order_conditions>][\nLIMIT <?count> OFFSET <offset|0>]\n)][<?!order_conditions>[DELETE \nFROM <from_tables>[,<*from_tables>] WHERE rowid IN (\nSELECT rowid FROM <from_tables>[,<*from_tables>][[\nWHERE (<?where_conditions_required>) [AND (<?where_conditions>)]][<?!where_conditions_required>[\nWHERE <?where_conditions>]]\nLIMIT <?count> OFFSET <offset|0>\n)]]"}}};return v=function F(e){var n=this;if(!(n instanceof F))return new F(e);if(arguments.length||(e="mysql"),!e||!F.dialects[e]||!F.dialects[e].clauses)throw new TypeError('Dialect: SQL dialect does not exist for "'+e+'"');n.clau=null,n.clus=null,n.tbls=null,n.cols=null,n.vews={},n.tpls={},n.db=null,n.escdb=null,n.p="",n.type=e,n.clauses=F.dialects[n.type].clauses,n.q=F.dialects[n.type].quotes[0],n.qn=F.dialects[n.type].quotes[1],n.e=F.dialects[n.type].quotes[2]||["",""]},v.VERSION="0.5.4",v.TPL_RE=/\$\(([^\)]+)\)/g,v.dialects=L,v.GrammTpl=g,v.Tpl=E,v.Ref=q,v[w]={constructor:v,clau:null,clus:null,tbls:null,cols:null,vews:null,tpls:null,db:null,escdb:null,p:null,type:null,clauses:null,q:null,qn:null,e:null,dispose:function(){var e=this;return e.clau=null,e.clus=null,e.tbls=null,e.cols=null,e.vews=null,e.tpls=null,e.db=null,e.escdb=null,e.p=null,e.type=null,e.clauses=null,e.q=null,e.qn=null,e.e=null,e},toString:function(){return this.sql()||""},driver:function(e){var n=this;return arguments.length?(n.db=e?e:null,n):n.db},escape:function(e){var n=this;return arguments.length?(n.escdb=e&&r(e)?e:null,n):n.escdb},prefix:function(e){var n=this;return arguments.length?(n.p=e&&e.length?e:"",n):n.p},reset:function(e){var n=this;if(!e||!n.clauses[m](e))throw new TypeError('Dialect: SQL clause "'+e+'" does not exist for dialect "'+n.type+'"');return n.clus={},n.tbls={},n.cols={},n.clau=e,n.clauses[n.clau]instanceof g||(n.clauses[n.clau]=new g(n.clauses[n.clau])),n},clear:function(){var e=this;return e.clau=null,e.clus=null,e.tbls=null,e.cols=null,e},sql:function(){var e=this,n=null;return e.clau&&e.clauses[m](e.clau)&&(n=e.clauses[e.clau].render(e.clus)||""),e.clear(),n},prepare:function(e,n,t,r){var i,u,c,a,_,f,h,p,b,E,g=this;if(e&&n){for(t=t?s(t):"%",r=r?s(r):"%",i=l(t+"([rlfds]:)?([0-9a-zA-Z_]+)"+r),E="";e.length&&(u=e.match(i));){if(c=u.index,a=u[0].length,p=u[2],n[m](p)){switch(b=u[1]?u[1].slice(0,-1):"s"){case"r":p=o(n[p])?n[p].join(","):n[p];break;case"l":p=g.like(n[p]);break;case"f":if(o(n[p]))for(h=d(n[p]),p=q.parse(h[0],g).tbl_col_alias_q,_=1,f=h.length;f>_;_++)p+=","+q.parse(h[_],g).tbl_col_alias_q;else p=q.parse(n[p],g).tbl_col_alias_q;break;case"d":p=o(n[p])?g.intval(d(n[p])).join(","):g.intval(n[p]);break;case"s":default:p=o(n[p])?g.quote(d(n[p])).join(","):g.quote(n[p])}E+=e.slice(0,c)+p}else E+=e.slice(0,c)+g.quote("");e=e.slice(c+a)}return e.length&&(E+=e),E}return e},make_view:function(e){var n=this;return e&&n.clau&&(n.vews[e]={clau:n.clau,clus:n.clus,tbls:n.tbls,cols:n.cols},n.vews[e].clus[m]("where_conditions")&&(n.vews[e].clus.where_conditions&&(n.vews[e].clus.where_conditions_required=n.vews[e].clus.where_conditions),delete n.vews[e].clus.where_conditions),n.vews[e].clus[m]("having_conditions")&&(n.vews[e].clus.having_conditions&&(n.vews[e].clus.having_conditions_required=n.vews[e].clus.having_conditions),delete n.vews[e].clus.having_conditions),n.clear()),n},clear_view:function(e){var n=this;return e&&n.vews[m](e)&&delete n.vews[e],n},prepare_tpl:function(e){var n,t,r,i,o,u,a,_,d,f,h,p,b,g=this;if(!c(e)){for(_=arguments,d=_.length,1===d?(f=null,h=null,p=null,b=!0):2===d?(f=_[1],h=null,p=null,b=!1):3===d?(f=null,h=_[1],p=_[2],b=!0):(f=_[1],h=_[2],p=_[3],b=!1),h=h?s(h):"%",p=p?s(p):"%",n=l(h+"(([rlfds]:)?[0-9a-zA-Z_]+)"+p),t=b?new E(g.sql(),n):new E(f,n),r={},i=0,o=t.tpl.length;o>i;i++)u=t.tpl[i],0===u[0]&&(a=u[1].split(":"),a.length>1?(r[a[1]]=a[0],t.tpl[i][1]=a[1]):(r[a[0]]="s",t.tpl[i][1]=a[0]));g.tpls[e]={sql:t,types:r}}return g},prepared:function(e,n){var t,l,s,r,i,u,a,_,f,h=this;if(!c(e)&&h.tpls[m](e)){t=h.tpls[e].sql,l=h.tpls[e].types,r={};for(i in n)if(n[m](i))switch(u=n[i],s=l[m](i)?l[i]:"s"){case"r":r[i]=o(u)?u.join(","):u;break;case"l":r[i]=h.like(u);break;case"f":if(o(u))for(a=d(u),r[i]=q.parse(a[0],h).tbl_col_alias_q,_=1,f=a.length;f>_;_++)r[i]+=","+q.parse(a[_],h).tbl_col_alias_q;else r[i]=DialectRef.parse(u,h).tbl_col_alias_q;break;case"d":r[i]=o(u)?h.intval(d(u)).join(","):h.intval(u);break;case"s":default:r[i]=o(u)?h.quote(d(u)).join(","):h.quote(u)}return t.render(r)}return""},clear_tpl:function(e){var n=this;return!c(e)&&n.tpls[m](e)&&(n.tpls[e].sql.dispose(),delete n.tpls[e]),n},create:function(e,n,t,l,s){var r=this;return r.reset(s||"create"),e=r.refs(e,r.tbls,!1!==l)[0].tbl_col_q,r.clus.create_table=e,r.clus.create_defs&&(n=r.clus.create_defs+","+n),r.clus.create_defs=n,t&&(r.clus.create_opts&&(t=r.clus.create_opts+","+t),r.clus.create_opts=t),r},alter:function(e,n,t,l,s){var r=this;return r.reset(s||"alter"),e=r.refs(e,r.tbls,!1!==l)[0].tbl_col_q,r.clus.alter_table=e,r.clus.alter_defs&&(n=r.clus.alter_defs+","+n),r.clus.alter_defs=n,t&&(r.clus.alter_opts&&(t=r.clus.alter_opts+","+t),r.clus.alter_opts=t),r},drop:function(e,n,t){var l,s,r,i=this;if(i.reset(t||"drop"),e&&e.length&&"*"!==e)for(r=i.refs(e,i.tbls,!1!==n),e=r[0].tbl_col_q,l=1,s=r.length;s>l;l++)e+=","+r[l].tbl_col_q;else e="*";return i.clus.drop_tables&&(e=i.clus.drop_tables+","+e),i.clus.drop_tables=e,i},select:function(e,n,t){var l,s,r,i=this;if(i.reset(t||"select"),e&&e.length&&"*"!==e)for(e=i.refs(e,i.cols,!1!==n),r=e[0].tbl_col_alias_q,l=1,s=e.length;s>l;l++)r+=","+e[l].tbl_col_alias_q;else r="*";return i.clus.select_columns&&(r=i.clus.select_columns+","+r),i.clus.select_columns=r,i},insert:function(e,n,t,l){var s,r,i,u,c,a=this;if(a.reset(l||"insert"),i=o(e)?e[0]:e,a.vews[m](i)&&a.clau===a.vews[i].clau)i=a.vews[i],a.clus=h(a.clus,i.clus,!0),a.tbls=h({},i.tbls,!0),a.cols=h({},i.cols,!0);else{for(e=a.refs(e,a.tbls,!1!==t),n=a.refs(n,a.cols,!1!==t),u=e[0].tbl_col_alias_q,c=n[0].tbl_col_q,s=1,r=e.length;r>s;s++)u+=","+e[s].tbl_col_alias_q;for(s=1,r=n.length;r>s;s++)c+=","+n[s].tbl_col_q;a.clus.insert_tables&&(u=a.clus.insert_tables+","+u),a.clus.insert_columns&&(c=a.clus.insert_columns+","+c),a.clus.insert_tables=u,a.clus.insert_columns=c}return a},values:function(e){var t,l,s,r,i,a,f,h,p=this;if(c(e))return p;for(n!==e[0]&&o(e[0])||(e=[e]),t=e.length,l=[],r=0;t>r;r++)if(h=d(e[r]),h.length){for(s=[],a=0,f=h.length;f>a;a++)i=h[a],u(i)?i[m]("integer")?s.push(p.intval(i.integer)):i[m]("raw")?s.push(i.raw):i[m]("string")&&s.push(p.quote(i.string)):s.push(_(i)?i:p.quote(i));l.push("("+s.join(",")+")")}return l=l.join(","),p.clus.values_values&&(l=p.clus.values_values+","+l),p.clus.values_values=l,p},update:function(e,n,t){var l,s,r,i,u=this;if(u.reset(t||"update"),r=o(e)?e[0]:e,u.vews[m](r)&&u.clau===u.vews[r].clau)r=u.vews[r],u.clus=h(u.clus,r.clus,!0),u.tbls=h({},r.tbls,!0),u.cols=h({},r.cols,!0);else{for(e=u.refs(e,u.tbls,!1!==n),i=e[0].tbl_col_alias_q,l=1,s=e.length;s>l;l++)i+=","+e[l].tbl_col_alias_q;u.clus.update_tables&&(i=u.clus.update_tables+","+i),u.clus.update_tables=i}return u},set:function(e){var n,t,l,s,r,i=this;if(c(e))return i;n=[],r=i.cols;for(t in e)e[m](t)&&(l=i.refs(t,r)[0].tbl_col_q,s=e[t],u(s)?s[m]("integer")?n.push(l+" = "+i.intval(s.integer)):s[m]("raw")?n.push(l+" = "+s.raw):s[m]("string")?n.push(l+" = "+i.quote(s.string)):s[m]("increment")?n.push(l+" = "+l+" + "+i.intval(s.increment)):s[m]("decrement")&&n.push(l+" = "+l+" - "+i.intval(s.increment)):n.push(l+" = "+(_(s)?s:i.quote(s))));return n=n.join(","),i.clus.set_values&&(n=i.clus.set_values+","+n),i.clus.set_values=n,i},del:function(e){var n=this;return n.reset(e||"delete"),n},from:function(e,n){var t,l,s,r,i,u,a=this;if(c(e))return a;if(s=o(e)?e[0]:e,a.vews[m](s)&&a.clau===a.vews[s].clau){if(i=c(a.clus.select_columns)||"*"==a.clus.select_columns?null:a.refs(a.clus.select_columns,{},!1),s=a.vews[s],a.clus=h(a.clus,s.clus,!0),a.tbls=h({},s.tbls,!0),a.cols=h({},s.cols,!0),i){for(i=a.refs2(i,a.cols),u=i[0].tbl_col_alias_q,t=1,l=i.length;l>t;t++)u+=","+i[t].tbl_col_alias_q;a.clus.select_columns=u}}else{for(e=a.refs(e,a.tbls,!1!==n),r=e[0].tbl_col_alias_q,t=1,l=e.length;l>t;t++)r+=","+e[t].tbl_col_alias_q;a.clus.from_tables&&(r=a.clus.from_tables+","+r),a.clus.from_tables=r}return a},join:function(e,n,t){var l,s,r,o=this;if(e=o.refs(e,o.tbls)[0].tbl_col_alias_q,c(n))l=e;else{if(i(n))n=o.refs(n.split("="),o.cols),n="("+n[0].tbl_col_q+"="+n[1].tbl_col_q+")";else{for(s in n)n[m](s)&&(r=n[s],u(r)||(n[s]={eq:r,type:"identifier"}));n=o.conditions(n,!1)}l=e+" ON "+n}return l=(c(t)?"JOIN ":t.toUpperCase()+" JOIN ")+l,o.clus.join_clauses&&(l=o.clus.join_clauses+"\n"+l),o.clus.join_clauses=l,o},where:function(e,n){var t=this;return c(e)?t:(n=n?n.toUpperCase():"AND","OR"!==n&&(n="AND"),e=t.conditions(e,!1),t.clus.where_conditions&&(e=t.clus.where_conditions+" "+n+" "+e),t.clus.where_conditions=e,t)},group:function(e,n){var t,l=this;return n=n?n.toUpperCase():"ASC","DESC"!==n&&(n="ASC"),t=l.refs(e,l.cols)[0].alias_q+" "+n,l.clus.group_conditions&&(t=l.clus.group_conditions+","+t),l.clus.group_conditions=t,l},having:function(e,n){var t=this;return c(e)?t:(n=n?n.toUpperCase():"AND","OR"!==n&&(n="AND"),e=t.conditions(e,!0),t.clus.having_conditions&&(e=t.clus.having_conditions+" "+n+" "+e),t.clus.having_conditions=e,t)},order:function(e,n){var t,l=this;return n=n?n.toUpperCase():"ASC","DESC"!==n&&(n="ASC"),t=l.refs(e,l.cols)[0].alias_q+" "+n,l.clus.order_conditions&&(t=l.clus.order_conditions+","+t),l.clus.order_conditions=t,l},limit:function(e,n){var t=this;return t.clus.count=a(e),t.clus.offset=a(n),t},page:function(e,n){var t=this;return e=a(e),n=a(n),t.limit(n,e*n)},refs:function(e,n,t){var l,s,r,i,o,u,c,a,_,f=this;for(t=!1!==t,u=d(e),e=[],l=0,s=u.length;s>l;l++)for(o=u[l].split(","),r=0,i=o.length;i>r;r++)c=q.parse(o[r],f,t),t?(a=c.alias_q,_=c.tbl_col_q):(a=f.quote_name(c.alias_q),_=f.quote_name(c.tbl_col_q)),n[m](a)?c=n[a]:(n[a]=c,_===a||n[m](_)||(n[_]=c)),e.push(c);return e},refs2:function(e,n){var t,l,s,r,i,o,u,c,a=this;for(t=0,l=e.length;l>t;t++)s=e[t],i=a.quote_name(s.alias_q),o=a.quote_name(s.tbl_col_q),n[m](i)?e[t]=n[i]:n[m](o)?(r=n[o],u=a.quote_name(r.alias_q),c=a.quote_name(r.tbl_col_q),c!==o&&u!==i&&u===o&&(c!==u&&n[m](u)&&delete n[u],r=r.cloned(s.alias_q),e[t]=n[c]=r,i===c||n[m](i)||(n[i]=r))):(n[i]=s,i===o||n[m](o)||(n[o]=s));return e},join_conditions:function(e,n){var t,l,s,r,i,o,u,c,a,_,d,f,h=this,p=0;for(t in n)n[m](t)&&(l=q.parse(t,h),s=l.col,e[m](s)&&(r=n[t],o=e[s].table,u=e[s].id,c=e[s].join,a=e[s].join_id,p++,_=c+p,i={},e[s][m]("key")&&s!==e[s].key?(d=e[s].key,i[_+"."+d]=s):d=s,e[s][m]("value")?(f=e[s].value,i[_+"."+f]=r):(f=d,i[_+"."+f]=r),h.join(c+" AS "+_,o+"."+u+"="+_+"."+a,"inner").where(i),delete n[t]));return h},conditions:function(e,n){var t,l,s,r,o,a,f,h,p,b,E=this;if(c(e))return"";if(i(e))return e;t="",l=[],b=E.cols,a=!0===n?"alias_q":"tbl_col_q";for(s in e)e[m](s)&&(r=E.refs(s,b)[0][a],o=e[s],u(o)?(h=o[m]("type")?o.type:"string",o[m]("multi_like")?l.push(E.multi_like(r,o.multi_like)):o[m]("like")?l.push(r+" LIKE "+("raw"===h?o.like:E.like(o.like))):o[m]("not_like")?l.push(r+" NOT LIKE "+("raw"===h?o.not_like:E.like(o.not_like))):o[m]("in")?(p=d(o["in"]),"raw"===h||(p="integer"===h||_(p[0])?E.intval(p):E.quote(p)),l.push(r+" IN ("+p.join(",")+")")):o[m]("not_in")?(p=d(o.not_in),"raw"===h||(p="integer"===h||_(p[0])?E.intval(p):E.quote(p)),l.push(r+" NOT IN ("+p.join(",")+")")):o[m]("between")?(p=d(o.between),"raw"===h||(p="integer"===h||_(p[0])&&_(p[1])?E.intval(p):E.quote(p)),l.push(r+" BETWEEN "+p[0]+" AND "+p[1])):o[m]("not_between")?(p=d(o.not_between),"raw"===h||(p="integer"===h||_(p[0])&&_(p[1])?E.intval(p):E.quote(p)),l.push(r+" < "+p[0]+" OR "+r+" > "+p[1])):o[m]("gt")||o[m]("gte")?(f=o[m]("gt")?"gt":"gte",p=o[f],"raw"===h||(p="integer"===h||_(p)?E.intval(p):"identifier"===h||"field"===h?E.refs(p,b)[0][a]:E.quote(p)),l.push(r+("gt"===f?" > ":" >= ")+p)):o[m]("lt")||o[m]("lte")?(f=o[m]("lt")?"lt":"lte",p=o[f],"raw"===h||(p="integer"===h||_(p)?E.intval(p):"identifier"===h||"field"===h?E.refs(p,b)[0][a]:E.quote(p)),l.push(r+("lt"===f?" < ":" <= ")+p)):o[m]("not_equal")||o[m]("not_eq")?(f=o[m]("not_eq")?"not_eq":"not_equal",p=o[f],"raw"===h||(p="integer"===h||_(p)?E.intval(p):"identifier"===h||"field"===h?E.refs(p,b)[0][a]:E.quote(p)),l.push(r+" <> "+p)):(o[m]("equal")||o[m]("eq"))&&(f=o[m]("eq")?"eq":"equal",p=o[f],"raw"===h||(p="integer"===h||_(p)?E.intval(p):"identifier"===h||"field"===h?E.refs(p,b)[0][a]:E.quote(p)),l.push(r+" = "+p))):l.push(r+" = "+(_(o)?o:E.quote(o))));return l.length&&(t="("+l.join(") AND (")+")"),t},tbl:function(e){var n=this,t=n.p;return o(e)?p(e,function(e){return t+e}):t+e},intval:function(e){return o(e)?p(e,a):a(e)},quote_name:function(e){var n=this,t=n.qn;return o(e)?p(e,function(e){return"*"===e?e:(t[0]==e.slice(0,t[0].length)?"":t[0])+e+(t[1]==e.slice(-t[1].length)?"":t[1])}):"*"===e?e:(t[0]==e.slice(0,t[0].length)?"":t[0])+e+(t[1]==e.slice(-t[1].length)?"":t[1])},quote:function(e){var n=this,t=n.q;return o(e)?p(e,function(e){return t[0]+n.esc(e)+t[1]}):t[0]+n.esc(e)+t[1]},like:function(e){var n=this,t=n.q,l=n.escdb?["",""]:n.e;return o(e)?p(e,function(e){return l[0]+t[0]+"%"+n.esc_like(n.esc(e))+"%"+t[1]+l[1]}):l[0]+t[0]+"%"+n.esc_like(n.esc(e))+"%"+t[1]+l[1]},multi_like:function(e,n,t){var l,s,r,i,o,u,c,a=this;for(t=!1!==t,l=e+" LIKE ",s=n.split(","),t&&(s=b(p(s,N),Boolean)),i=0,o=s.length;o>i;i++){for(r=s[i].split("+"),t&&(r=b(p(r,N),Boolean)),u=0,c=r.length;c>u;u++)r[u]=l+a.like(r[u]);s[i]="("+r.join(" AND ")+")"}return s.join(" OR ")},esc:function(e){var n,t,l,s,r,i,u=this,c=u.q;if(u.escdb)return o(e)?p(e,u.escdb):u.escdb(e);if(o(e))return p(e,function(e){return u.esc(e)});for(n="\\"+D,t="\\",e=String(e),r="",l=0,s=e.length;s>l;l++)i=e.charAt(l),r+=c[0]===i?c[2]:c[1]===i?c[3]:f(i,n,t);return r},esc_like:function(e){var n="_%",t="\\";return o(e)?p(e,function(e){return f(e,n,t)}):f(e,n,t)}},v});